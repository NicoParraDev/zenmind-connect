{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala: {{ room.name }} - ZenMindConnect 2.0</title>
    <meta name="description" content="Videollamada en curso - ZenMindConnect">
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Agora RTC SDK -->
    <script src="{% static 'videocall/assets/AgoraRTC_N-4.8.0.js' %}"></script>
    
    <!-- Suprimir error conocido de AgoraRTC getStats -->
    <script>
        // Interceptar errores de Promise no capturados para filtrar el error conocido de AgoraRTC
        window.addEventListener('unhandledrejection', function(event) {
            const error = event.reason;
            // Filtrar el error específico de getStats de AgoraRTC
            if (error && (
                (error.message && error.message.includes("Failed to execute 'getStats' on 'RTCPeerConnection'")) ||
                (error.toString && error.toString().includes("Failed to execute 'getStats' on 'RTCPeerConnection'")) ||
                (typeof error === 'string' && error.includes("Failed to execute 'getStats' on 'RTCPeerConnection'"))
            )) {
                // Suprimir este error específico (es un bug conocido del SDK v4.8.0)
                event.preventDefault();
                return;
            }
            // Permitir que otros errores se muestren normalmente
        });
    </script>
    
    <!-- CSS ZenMind 2.0 -->
    <link rel="stylesheet" href="{% static 'CSS/zenmind_2.0_base.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/zenmind_2.0_navbar.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/zenmind_2.0_components.css' %}">
    
    <link rel="icon" href="{% static 'IMG/logo_final.png' %}">
    
    <style>
        body {
            background-color: #0a0e27;
            font-family: var(--font-primary);
            overflow: hidden;
            height: 100vh;
        }
        
        .videocall-room-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        /* Header con información de la sala */
        .room-header {
            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            z-index: 1000;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            color: white;
        }
        
        .room-info h2 {
            margin: 0;
            font-size: var(--font-xl);
            font-weight: 600;
            color: white;
        }
        
        .room-info .room-name {
            color: #667eea;
            font-weight: 700;
        }
        
        .room-timer {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: #10b981;
            font-weight: 600;
            font-size: var(--font-lg);
        }
        
        /* Contenedor principal: video + chat */
        .room-main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        
        /* Área de video */
        .video-container-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0e27;
            position: relative;
            overflow: hidden;
        }
        
        .video-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            overflow-y: auto;
        }
        
        /* Cuando hay solo un participante, ocupar casi toda la pantalla */
        .video-grid > div[id^="user-container-"]:only-child {
            max-width: 95vw;
            max-height: 75vh;
            width: 90vw;
            height: 70vh;
            margin: 0 auto;
        }
        
        .video-item {
            position: relative;
            background: #1a1f3a;
            border-radius: var(--radius-lg);
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .video-item:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }
        
        .video-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-item.local-video {
            border-color: #10b981;
        }
        
        /* Estilos para los contenedores de video individuales creados por Agora */
        #video-grid > div[id^="user-container-"] {
            position: relative;
            background: #1a1f3a;
            border-radius: var(--radius-lg);
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            min-height: 200px;
        }
        
        #video-grid > div[id^="user-container-"]:hover {
            border-color: #667eea;
            transform: scale(1.02);
            cursor: pointer;
        }
        
        /* Botón de expandir video */
        .expand-video-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 21;
            opacity: 0;
            transition: opacity 0.3s ease, background 0.3s ease;
            font-size: var(--font-sm);
        }
        
        #video-grid > div[id^="user-container-"]:hover .expand-video-btn {
            opacity: 1;
        }
        
        .expand-video-btn:hover {
            background: rgba(102, 126, 234, 0.9);
            transform: scale(1.1);
        }
        
        /* Botón de mute individual para usuarios remotos */
        .mute-remote-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 21;
            opacity: 0;
            transition: opacity 0.3s ease, background 0.3s ease;
            font-size: var(--font-sm);
        }
        
        #video-grid > div[id^="user-container-"]:hover .mute-remote-btn {
            opacity: 1;
        }
        
        .mute-remote-btn:hover {
            background: rgba(239, 68, 68, 0.9);
            transform: scale(1.1);
        }
        
        .mute-remote-btn.muted {
            background: rgba(239, 68, 68, 0.9);
            opacity: 1;
        }
        
        .mute-remote-btn.muted:hover {
            background: rgba(239, 68, 68, 1);
        }
        
        /* Asegurar que el botón expandir siempre esté en la esquina superior derecha */
        #video-grid > div[id^="user-container-"] .expand-video-btn {
            top: 10px !important;
            right: 10px !important;
        }
        
        /* Si hay botón de mute, el expandir sigue en la derecha */
        #video-grid > div[id^="user-container-"]:has(.mute-remote-btn) .expand-video-btn {
            top: 10px !important;
            right: 10px !important;
        }
        
        /* Vista expandida del video - Usando zoom CSS en lugar de reproducir track */
        .video-expanded-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.98);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            pointer-events: auto;
        }
        
        .video-expanded-overlay.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .video-expanded-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        /* Clase para el contenedor original cuando está expandido */
        .video-container-expanded {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) scale(2.5) !important;
            width: 40vw !important;
            height: 30vh !important;
            z-index: 10001 !important;
            transition: transform 0.3s ease !important;
        }
        
        .video-container-expanded .video-player {
            width: 100% !important;
            height: 100% !important;
        }
        
        .video-container-expanded .video-player video {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
        }
        
        .video-expanded-name {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-size: var(--font-xl);
            font-weight: 600;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(102, 126, 234, 0.5);
        }
        
        /* Cuando el video está expandido, el botón de expandir cambia a comprimir */
        .video-container-expanded .expand-video-btn {
            background: rgba(239, 68, 68, 0.9) !important;
            opacity: 1 !important;
            z-index: 10002 !important;
        }
        
        .video-container-expanded .expand-video-btn:hover {
            background: rgba(239, 68, 68, 1) !important;
        }
        
        .video-container-expanded .expand-video-btn i.fa-expand {
            display: none;
        }
        
        .video-container-expanded .expand-video-btn i.fa-compress {
            display: block !important;
        }
        
        .expand-video-btn i.fa-compress {
            display: none;
        }
        
        #video-grid > div[id^="user-container-"] .video-player {
            width: 100%;
            height: 100%;
            min-height: 200px;
            background: #1a1f3a;
            position: relative;
        }
        
        /* Placeholder cuando la cámara está apagada - Diseño profesional y limpio */
        .video-player.camera-off {
            background: #1a1f3a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .camera-off-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        
        .camera-off-placeholder .user-initials {
            width: 60px !important;
            height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            max-width: 60px !important;
            max-height: 60px !important;
            border-radius: 50% !important;
            background: linear-gradient(to top, #7c3aed 0%, #a78bfa 100%) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 1.4em !important;
            font-weight: 700 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            border: none !important;
            letter-spacing: 1px !important;
            position: relative !important;
            text-shadow: 
                0 0 0 white,
                -1px -1px 0 rgba(255, 0, 150, 0.3),
                1px 1px 0 rgba(0, 200, 255, 0.3) !important;
        }
        
        /* Efecto sutil de glitch/aberration cromática */
        .camera-off-placeholder .user-initials::before,
        .camera-off-placeholder .user-initials::after {
            content: attr(data-initials) !important;
            position: absolute !important;
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 1.4em !important;
            font-weight: 700 !important;
            letter-spacing: 1px !important;
        }
        
        .camera-off-placeholder .user-initials::before {
            color: rgba(255, 0, 150, 0.4) !important;
            transform: translate(-1px, -1px) !important;
            z-index: -1 !important;
        }
        
        .camera-off-placeholder .user-initials::after {
            color: rgba(0, 200, 255, 0.4) !important;
            transform: translate(1px, 1px) !important;
            z-index: -1 !important;
        }
        
        .camera-off-placeholder .camera-icon,
        .camera-off-placeholder .user-name {
            display: none;
        }
        
        /* Estilos para el elemento video que Agora crea dentro de video-player */
        #video-grid > div[id^="user-container-"] .video-player > div,
        #video-grid > div[id^="user-container-"] .video-player video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            display: block;
        }
        
        /* Asegurar que cualquier elemento hijo de video-player ocupe todo el espacio */
        #video-grid > div[id^="user-container-"] .video-player * {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Video local con borde verde */
        #video-grid > div[id^="user-container-"].local-video-item {
            border-color: #10b981;
        }
        
        /* Indicador de voz - cuando alguien está hablando */
        #video-grid > div[id^="user-container-"].user-speaking {
            border-color: #10b981 !important;
            border-width: 4px !important;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.9), 0 0 50px rgba(16, 185, 129, 0.5) !important;
            transition: border-color 0.1s ease, box-shadow 0.1s ease;
            transform: scale(1.02);
        }
        
        .speaking-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 15;
            animation: speakingPulse 1s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.6), 0 0 20px rgba(16, 185, 129, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .speaking-indicator i {
            animation: microphonePulse 0.6s ease-in-out infinite;
            font-size: 1.1em;
        }
        
        @keyframes speakingPulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.6), 0 0 20px rgba(16, 185, 129, 0.4);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.9), 0 0 30px rgba(16, 185, 129, 0.6);
            }
        }
        
        @keyframes microphonePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
        }
        
        /* Wrapper de nombre de usuario */
        .username-wrapper {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 600;
            z-index: 10;
        }
        
        .user-name {
            color: white;
        }
        
        .video-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
            background: #1a1f3a;
        }
        
        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 600;
        }
        
        /* Panel de chat */
        /* Panel lateral: usuarios O chat (alternativo) */
        .side-panel {
            width: 350px;
            background: #1a1f3a;
            border-left: 2px solid rgba(102, 126, 234, 0.3);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, border-width 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .side-panel.hidden {
            width: 0;
            border-left-width: 0;
            opacity: 0;
            pointer-events: none;
        }
        
        /* Panel de usuarios */
        .users-panel {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .users-panel.hidden {
            display: none;
        }
        
        .users-header {
            padding: var(--spacing-md);
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .users-header h3 {
            margin: 0;
            color: white;
            font-size: var(--font-md);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
        }
        
        .user-item {
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .user-item.current-user {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
            min-width: 0;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            flex-shrink: 0;
        }
        
        .user-details {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            color: white;
            font-weight: 500;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-role {
            color: #a0aec0;
            font-size: 0.75em;
            text-transform: capitalize;
        }
        
        .user-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .kick-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8em;
        }
        
        .kick-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        
        .kick-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .users-count {
            color: #a0aec0;
            font-size: 0.85em;
            margin-top: var(--spacing-xs);
        }
        
        .chat-panel {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-panel.hidden {
            display: none;
        }
        
        /* Cuando el chat está oculto, el área de video se expande automáticamente */
        /* El flexbox se ajusta automáticamente cuando el chat tiene width: 0 */
        
        /* Asegurar que el área de video ocupe todo el espacio cuando el chat está oculto */
        .room-main-content.chat-hidden .video-container-area {
            flex: 1 1 100%;
            width: 100%;
        }
        
        .chat-header {
            padding: var(--spacing-md);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            margin: 0;
            font-size: var(--font-lg);
            font-weight: 600;
        }
        
        .chat-toggle-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: var(--font-xl);
            padding: var(--spacing-xs);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .no-messages {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: #a0aec0;
            font-size: 0.95em;
            font-style: italic;
            opacity: 0.8;
            margin: auto;
        }
        
        .chat-message {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            max-width: 80%;
            word-wrap: break-word;
            margin-bottom: var(--spacing-sm);
            display: block;
            visibility: visible;
            opacity: 1;
            animation: slideIn 0.2s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Mensajes nuevos con transición suave */
        .chat-message[data-message-id] {
            will-change: opacity, transform;
        }
        
        /* Indicador de escritura */
        .typing-indicator {
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: #a0aec0;
            font-style: italic;
            font-size: 0.9em;
            margin-top: var(--spacing-xs);
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #667eea;
            animation: typingDot 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }
        
        .typing-text {
            color: #a0aec0;
        }
        
        .chat-message.own-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }
        
        .chat-message.other-message {
            align-self: flex-start;
            background: #2d3748;
            color: white;
            margin-right: auto;
        }
        
        /* Asegurar que los mensajes sin clase específica también se muestren */
        .chat-message:not(.own-message):not(.other-message) {
            align-self: flex-start;
            background: #2d3748;
            color: white;
            margin-right: auto;
        }
        
        .message-author {
            font-weight: 600;
            font-size: var(--font-xs);
            margin-bottom: var(--spacing-xs);
            opacity: 0.8;
        }
        
        .message-time {
            font-size: var(--font-xs);
            opacity: 0.6;
            margin-top: var(--spacing-xs);
        }
        
        .chat-input-container {
            padding: var(--spacing-md);
            border-top: 2px solid rgba(102, 126, 234, 0.3);
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .chat-input {
            flex: 1;
            padding: var(--spacing-md);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-md);
            background: #0a0e27;
            color: white;
            font-size: var(--font-base);
            font-family: var(--font-primary);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .chat-send-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Barra superior de dispositivos y efectos */
        .top-controls-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 200;
            gap: var(--spacing-lg);
        }
        
        .device-selectors {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }
        
        .device-selector-group {
            position: relative;
        }
        
        .device-selector-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-sm);
            min-width: 150px;
        }
        
        .device-selector-btn:hover {
            background: rgba(45, 55, 72, 1);
            border-color: rgba(102, 126, 234, 0.6);
        }
        
        .device-selector-btn i:first-child {
            font-size: 1em;
        }
        
        .device-selector-btn span {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .device-selector-btn i:last-child {
            font-size: 0.8em;
            opacity: 0.7;
        }
        
        /* Grupo de control con dropdown (para barra inferior) */
        .control-with-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0;
            border-radius: 50px;
            overflow: visible; /* Cambiado de hidden a visible para que el dropdown se vea */
            background: transparent;
        }
        
        .control-with-dropdown .control-btn {
            border-radius: 50% 0 0 50%;
            margin: 0;
            border-right: none;
        }
        
        .control-dropdown-btn {
            width: 36px;
            height: 50px;
            border-radius: 0 50% 50% 0;
            border: none;
            border-left: 1px solid rgba(102, 126, 234, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: rgba(255, 255, 255, 0.8);
            margin-left: -1px;
            position: relative;
        }
        
        .control-dropdown-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 25%;
            bottom: 25%;
            width: 1.5px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(102, 126, 234, 0.5) 50%, 
                transparent 100%);
            border-radius: 1px;
        }
        
        .control-dropdown-btn:hover {
            background: linear-gradient(135deg, #3d4758 0%, #2d3748 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .control-with-dropdown.active .control-dropdown-btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.4) 0%, rgba(118, 75, 162, 0.4) 100%);
            color: white;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        /* Efecto de unión visual entre botones */
        .control-with-dropdown:hover .control-btn {
            transform: scale(1.02);
        }
        
        .control-with-dropdown:hover .control-dropdown-btn {
            transform: scale(1.02);
        }
        
        /* Sombra compartida cuando está activo */
        .control-with-dropdown.active {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Indicador de nivel de audio */
        .audio-level-indicator {
            position: relative !important;
            width: 8px !important;
            height: 32px !important;
            background: linear-gradient(180deg, rgba(20, 20, 40, 0.95) 0%, rgba(30, 30, 50, 0.95) 100%) !important;
            border-radius: 4px !important;
            overflow: hidden !important;
            display: flex !important; /* Forzar display */
            align-items: flex-end !important;
            margin-left: auto !important; /* Empujar al lado derecho del header */
            margin-right: 10px !important; /* Espacio desde el borde derecho */
            border: 2px solid rgba(102, 126, 234, 0.7) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(102, 126, 234, 0.2) !important;
            transition: opacity 0.2s ease;
            flex-shrink: 0 !important;
            opacity: 1 !important; /* Totalmente visible por defecto */
            visibility: visible !important;
            z-index: 10 !important;
            min-width: 8px !important;
            min-height: 32px !important;
        }
        
        .audio-level-bar {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 0% !important;
            background: linear-gradient(to top, 
                #10b981 0%, 
                #10b981 50%, 
                #f59e0b 75%, 
                #ef4444 100%) !important;
            border-radius: 3px !important;
            transition: height 0.08s linear !important; /* Transición rápida para suavidad */
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.5) !important;
            display: block !important;
            visibility: visible !important;
            z-index: 2 !important;
        }
        
        /* Más visible cuando hay audio */
        .audio-level-indicator.visible {
            opacity: 1 !important;
            border-color: rgba(102, 126, 234, 0.8) !important;
            box-shadow: 0 1px 8px rgba(102, 126, 234, 0.6) !important;
        }
        
        /* Asegurar visibilidad cuando el dropdown está abierto */
        .control-dropdown:not([style*="display: none"]) .audio-level-indicator {
            display: flex !important;
            visibility: visible !important;
        }
        
        /* Versión alternativa: barras múltiples */
        .audio-level-bars {
            position: absolute;
            left: 50%;
            bottom: calc(100% + 8px);
            transform: translateX(-50%);
            display: none;
            align-items: flex-end;
            gap: 2px;
            height: 24px;
            z-index: 10001;
            margin-bottom: 4px;
        }
        
        .control-with-dropdown:hover .audio-level-bars {
            display: flex;
        }
        
        .audio-level-bar-item {
            width: 3px;
            background: linear-gradient(to top, 
                #10b981 0%, 
                #10b981 50%, 
                #f59e0b 75%, 
                #ef4444 100%);
            border-radius: 2px;
            transition: height 0.15s ease;
            min-height: 4px;
        }
        
        .audio-level-bars.visible {
            display: flex;
        }
        
        .control-dropdown {
            position: absolute;
            bottom: calc(100% + 12px);
            left: 0;
            min-width: 280px;
            max-width: 320px;
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.98) 0%, rgba(20, 25, 50, 0.98) 100%) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(102, 126, 234, 0.2);
            display: none !important;
            z-index: 10001 !important; /* Aumentado para estar por encima de otros elementos */
            max-height: 350px;
            overflow-y: auto; /* Cambiado de hidden a auto para permitir scroll si es necesario */
            overflow-x: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            transform: translateY(10px);
        }
        
        .control-with-dropdown.active .control-dropdown {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            transform: translateY(0) !important;
        }
        
        /* Asegurar que el contenedor padre no corte el dropdown */
        .control-with-dropdown.active {
            overflow: visible !important;
            z-index: 10000;
        }
        
        /* Dropdowns de la barra superior (mantener para compatibilidad) */
        .device-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 250px;
            max-width: 300px;
            background: rgba(26, 31, 58, 0.98) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-md);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: none;
            z-index: 10000 !important;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
        }
        
        .device-selector-group.active .device-dropdown {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        .device-dropdown-header {
            padding: 16px 18px;
            font-weight: 600;
            color: white;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            font-size: 0.95em;
            background: rgba(102, 126, 234, 0.1);
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 12px;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        
        .device-dropdown-header::before {
            content: '';
            width: 3px;
            height: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .device-list {
            padding: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Scrollbar personalizado para device-list */
        .device-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .device-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .device-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }
        
        .device-list::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
        
        .device-item {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: white;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
            position: relative;
        }
        
        .device-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 2px 2px 0;
            transition: height 0.2s ease;
        }
        
        .device-item:hover {
            background: rgba(102, 126, 234, 0.25);
            transform: translateX(4px);
        }
        
        .device-item:hover::before {
            height: 60%;
        }
        
        .device-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            color: #c4b5fd;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .device-item.active::before {
            height: 80%;
        }
        
        .device-item i {
            font-size: 1em;
            opacity: 0.8;
            width: 20px;
            text-align: center;
        }
        
        .device-item.active i {
            opacity: 1;
            color: #a78bfa;
        }
        
        .device-item span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .device-loading {
            padding: 24px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .device-loading::before {
            content: '⏳';
            font-size: 1.2em;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .background-effects-group {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        
        .background-effect-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-sm);
        }
        
        .background-effect-btn:hover {
            background: rgba(45, 55, 72, 1);
            border-color: rgba(102, 126, 234, 0.6);
        }
        
        .background-effect-btn.active {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.8);
        }
        
        .settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background: rgba(45, 55, 72, 1);
            border-color: rgba(102, 126, 234, 0.6);
            transform: rotate(90deg);
        }
        
        /* Controles de video */
        .video-controls {
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
            border-top: 2px solid rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            z-index: 100;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-lg);
            transition: all 0.3s ease;
            background: #2d3748;
            color: white;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .control-btn.muted {
            background: #ef4444;
        }
        
        .control-btn.leave-btn {
            background: #ef4444;
            width: 60px;
            height: 60px;
        }
        
        .control-btn.leave-btn:hover {
            background: #dc2626;
        }
        
        .control-btn.hidden {
            display: none;
        }
        
        .control-btn.reactions-btn {
            background: #3b82f6;
        }
        
        .control-btn.reactions-btn:hover,
        .control-btn.reactions-btn.active {
            background: #2563eb;
        }
        
        .control-btn.raise-hand-btn {
            background: #10b981;
        }
        
        .control-btn.raise-hand-btn:hover {
            background: #059669;
        }
        
        .control-btn.raise-hand-btn.active {
            background: #059669;
            animation: handRaisedPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes handRaisedPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }
        
        /* Indicador de mano levantada en la esquina superior izquierda */
        .raised-hand-indicator {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(16, 185, 129, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(16, 185, 129, 0.5);
            animation: slideInLeft 0.3s ease-out;
        }
        
        .raised-hand-indicator.show {
            display: flex;
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .raised-hand-indicator .hand-icon {
            font-size: 1.5em;
            color: white;
            animation: handWave 1s ease-in-out infinite;
        }
        
        @keyframes handWave {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-20deg);
            }
            75% {
                transform: rotate(20deg);
            }
        }
        
        .raised-hand-indicator .user-name {
            color: white;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        /* Indicador en lista de participantes */
        .user-item.hand-raised {
            border-left: 4px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .user-item.hand-raised .hand-raised-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #10b981;
            font-size: 0.85em;
            margin-left: 8px;
        }
        
        .hand-raised-badge {
            display: none;
        }
        
        /* Panel de reacciones */
        .reactions-panel {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            flex-direction: column;
            gap: 12px;
            border: 2px solid rgba(102, 126, 234, 0.5);
        }
        
        .reactions-panel.show {
            display: flex;
        }
        
        /* Selector de tono de piel */
        .skin-tone-selector {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            justify-content: center;
        }
        
        .skin-tone-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .skin-tone-option:hover {
            transform: scale(1.2);
        }
        
        .skin-tone-option.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        
        /* Colores de tonos de piel */
        .skin-tone-1 { background: #ffdbac; } /* Amarillo claro */
        .skin-tone-2 { background: #f1c27d; } /* Beige claro */
        .skin-tone-3 { background: #e0ac69; } /* Beige medio */
        .skin-tone-4 { background: #c68642; } /* Beige oscuro */
        .skin-tone-5 { background: #8d5524; } /* Marrón claro */
        .skin-tone-6 { background: #654321; } /* Marrón oscuro */
        
        /* Barra de emojis */
        .emoji-reactions-bar {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 400px;
        }
        
        .emoji-reaction-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .emoji-reaction-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: scale(1.2);
        }
        
        .emoji-reaction-btn:active {
            transform: scale(0.9);
        }
        
        /* Animación de reacción en pantalla */
        .reaction-animation {
            position: fixed;
            pointer-events: none;
            z-index: 3000;
            font-size: 64px;
            animation: reactionFloat 3s ease-out forwards;
            user-select: none;
        }
        
        @keyframes reactionFloat {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            10% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
            90% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-200px) scale(1.5);
            }
        }
        
        /* Responsive */
        @media screen and (max-width: 768px) {
            .reactions-panel {
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                max-width: 90vw;
            }
            
            .emoji-reactions-bar {
                max-width: 100%;
            }
            
            .emoji-reaction-btn {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
            
            .room-main-content {
                flex-direction: column;
                padding-bottom: 90px; /* Espacio para la botonera fija */
            }
            
            .side-panel {
                width: 100%;
                height: 40vh;
                position: absolute;
                bottom: 0;
                right: 0;
                z-index: 1000;
            }
            
            .side-panel.hidden {
                width: 0;
                height: 0;
            }
            
            .users-panel,
            .chat-panel {
                width: 100%;
                height: 100%;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
            
            .room-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: flex-start;
            }
            
            /* Botonera optimizada para móviles */
            .video-controls {
                padding: var(--spacing-md) var(--spacing-sm);
                gap: var(--spacing-sm);
                flex-wrap: wrap;
                justify-content: space-around;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                box-sizing: border-box;
                border-top: 2px solid rgba(102, 126, 234, 0.5);
                backdrop-filter: blur(10px);
            }
            
            .control-btn {
                width: 48px;
                height: 48px;
                font-size: 1.1em;
                min-width: 48px;
                flex-shrink: 0;
            }
            
            .control-btn.leave-btn {
                width: 56px;
                height: 56px;
                font-size: 1.2em;
            }
        }
        
        /* Móviles pequeños (menos de 480px) */
        @media screen and (max-width: 480px) {
            .video-controls {
                padding: var(--spacing-sm);
                gap: 8px;
            }
            
            .control-btn {
                width: 44px;
                height: 44px;
                font-size: 1em;
            }
            
            .control-btn.leave-btn {
                width: 52px;
                height: 52px;
                font-size: 1.1em;
            }
        }
        
        /* Scrollbar personalizado */
        .chat-messages::-webkit-scrollbar,
        .video-grid::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track,
        .video-grid::-webkit-scrollbar-track {
            background: #0a0e27;
        }
        
        .chat-messages::-webkit-scrollbar-thumb,
        .video-grid::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover,
        .video-grid::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Pizarra colaborativa */
        .whiteboard-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            background: #ffffff;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .whiteboard-panel.open {
            transform: translateY(0);
        }
        
        .whiteboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .whiteboard-header h3 {
            margin: 0;
            font-size: var(--font-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .whiteboard-header-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            position: relative;
            z-index: 1;
        }
        
        .whiteboard-mode-selector {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 8px;
            font-size: var(--font-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .whiteboard-mode-selector:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .whiteboard-mode-selector option {
            background: #1a1f3a;
            color: white;
        }
        
        .whiteboard-drawing-indicator {
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 3px 10px;
            border-radius: 14px;
            font-size: 0.75rem;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: slideDownFade 0.3s ease-out;
            margin-right: var(--spacing-sm);
            position: relative !important;
            z-index: 1 !important;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whiteboard-drawing-indicator.show {
            display: flex;
        }
        
        .whiteboard-drawing-indicator i {
            animation: pulse 1.5s ease-in-out infinite;
            font-size: 0.8rem;
        }
        
        @keyframes slideDownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        
        .whiteboard-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.2em;
        }
        
        .whiteboard-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .whiteboard-toolbar {
            background: #f5f5f5;
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .whiteboard-tools-group,
        .whiteboard-colors-group,
        .whiteboard-width-group,
        .whiteboard-text-group,
        .whiteboard-actions-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .whiteboard-tool-btn,
        .whiteboard-color-btn,
        .whiteboard-width-btn,
        .whiteboard-action-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            position: relative !important;
            z-index: 10 !important;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }
        
        .whiteboard-tool-btn {
            width: 44px;
            height: 44px;
        }
        
        .whiteboard-tool-btn:hover,
        .whiteboard-tool-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .whiteboard-color-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid transparent;
        }
        
        .whiteboard-color-btn:hover,
        .whiteboard-color-btn.active {
            border-color: #333;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .whiteboard-custom-color {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            padding: 0;
            background: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .whiteboard-custom-color::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .whiteboard-custom-color::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }
        
        .whiteboard-custom-color::-moz-color-swatch {
            border: none;
            border-radius: 50%;
        }
        
        .whiteboard-custom-color:hover {
            border-color: #333;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .whiteboard-width-btn {
            min-width: 40px;
            height: 36px;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .whiteboard-width-btn:hover,
        .whiteboard-width-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .whiteboard-action-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            gap: var(--spacing-xs);
            font-size: 0.95em;
        }
        
        .whiteboard-action-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .whiteboard-canvas-container {
            flex: 1;
            overflow: hidden;
            background: #ffffff;
            position: relative;
        }
        
        #whiteboard-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            touch-action: none;
        }
        
        .control-btn.whiteboard-btn {
            position: relative;
        }
        
        .control-btn.whiteboard-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Responsive para pizarra */
        @media screen and (max-width: 768px) {
            .whiteboard-toolbar {
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
            }
            
            .whiteboard-tool-btn {
                width: 40px;
                height: 40px;
                font-size: 1em;
            }
            
            .whiteboard-color-btn {
                width: 32px;
                height: 32px;
            }
            
            .whiteboard-width-btn {
                min-width: 36px;
                height: 32px;
                font-size: 1em;
            }
            
            .whiteboard-action-btn {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="videocall-room-container">
        <!-- Header de la sala -->
        <div class="room-header">
            <div class="room-info">
                <i class="fas fa-video"></i>
                <h2>Sala: <span class="room-name">{{ room.name }}</span></h2>
                <span class="room-type-badge" id="room-type-badge" style="margin-left: var(--spacing-md); padding: var(--spacing-xs) var(--spacing-sm); background: rgba(102, 126, 234, 0.2); border-radius: var(--radius-md); font-size: var(--font-sm); color: #667eea;">
                    {% if room.room_type == 'group' %}
                        🌐 Evento Grupal
                    {% elif room.is_couple_therapy %}
                        💑 Terapia de Pareja
                    {% else %}
                        🔒 Sesión Privada
                    {% endif %}
                </span>
            </div>
            <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
                <div style="color: rgba(255, 255, 255, 0.7); font-size: var(--font-sm);">
                    <i class="fas fa-users"></i> 
                    <span id="member-count">{{ room.get_member_count }}</span> / {{ room.max_participants }}
                </div>
                <div class="room-timer">
                    <i class="fas fa-clock"></i>
                    <span id="room-timer">00:00:00</span>
                </div>
            </div>
        </div>
        
        <!-- Contenedor principal -->
        <div class="room-main-content">
            <!-- Área de video -->
            <div class="video-container-area">
                <div class="video-grid" id="video-grid">
                    <!-- Los videos se agregarán dinámicamente aquí -->
                </div>
                <!-- Contenedor alternativo para compatibilidad -->
                <div id="video-streams" style="display: none;"></div>
            </div>
            
        <!-- Overlay para video expandido -->
        <div class="video-expanded-overlay" id="video-expanded-overlay">
            <div class="video-expanded-container" id="video-expanded-container">
                <div class="video-expanded-name" id="video-expanded-name"></div>
            </div>
        </div>
            
            <!-- Elementos de audio para notificaciones (ocultos) -->
            <audio id="audio" preload="auto">
                <source src="{% static 'videocall/music/mixkit-positive-notification-951.wav' %}" type="audio/wav">
            </audio>
            <audio id="audio2" preload="auto">
                <source src="{% static 'videocall/music/mixkit-light-button-2580.wav' %}" type="audio/wav">
            </audio>
            <audio id="audio3" preload="auto">
                <source src="{% static 'videocall/music/mixkit-sci-fi-reject-notification-896.mp3' %}" type="audio/mpeg">
            </audio>
            <audio id="audio7" preload="auto">
                <source src="{% static 'videocall/music/pause record.wav' %}" type="audio/wav">
            </audio>
            <audio id="audio8" preload="auto">
                <source src="{% static 'videocall/music/start record.wav' %}" type="audio/wav">
            </audio>
            <audio id="audio5" preload="auto">
                <source src="{% static 'videocall/music/mixkit-software-interface-remove-2576.mp3' %}" type="audio/mpeg">
            </audio>
            <audio id="audio6" preload="auto">
                <source src="{% static 'videocall/music/mixkit-software-interface-back-2575.mp3' %}" type="audio/mpeg">
            </audio>
            
            <!-- Panel lateral: usuarios O chat (alternativo) -->
            <div class="side-panel" id="side-panel">
                <!-- Panel de usuarios -->
                <div class="users-panel" id="users-panel">
                    <div class="users-header">
                        <h3><i class="fas fa-users"></i> Participantes</h3>
                        <span class="users-count" id="users-count">0</span>
                    </div>
                    <div class="users-list" id="users-list">
                        <!-- Los usuarios se cargarán aquí -->
                    </div>
                </div>
                
                <!-- Panel de chat -->
                <div class="chat-panel hidden" id="chat-panel">
                    <div class="chat-header">
                        <h3><i class="fas fa-comments"></i> Chat</h3>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Los mensajes se cargarán aquí -->
                    </div>
                    <div class="chat-input-container">
                        <input 
                            type="text" 
                            id="chat-input-field" 
                            class="chat-input" 
                            placeholder="Escribe un mensaje..."
                            maxlength="5000"
                        />
                        <button id="chat-send-btn" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Barra superior de dispositivos y efectos - OCULTA (los selectores están en la barra inferior) -->
        <div class="top-controls-bar" id="top-controls-bar" style="display: none;">
            <!-- Ocultada porque los selectores están ahora en la barra inferior -->
        </div>
        
        <!-- Controles de video -->
        <div class="video-controls">
            <button id="more-options-btn" class="control-btn" title="Más opciones">
                <i class="fas fa-ellipsis-h"></i>
            </button>
            
            <!-- Grupo de micrófono con selector -->
            <div class="control-with-dropdown">
                <button id="mic-btn" class="control-btn active" title="Micrófono">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="mic-selector-btn" class="control-dropdown-btn" title="Seleccionar micrófono">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <!-- Indicador de nivel de audio -->
                <div class="control-dropdown" id="mic-device-dropdown">
                    <div class="device-dropdown-header">
                        Seleccionar micrófono
                        <div class="audio-level-indicator" id="mic-audio-level-indicator">
                            <div class="audio-level-bar" id="mic-audio-level-bar"></div>
                        </div>
                    </div>
                    <div class="device-list" id="mic-device-list">
                        <div class="device-loading">Cargando micrófonos...</div>
                    </div>
                </div>
            </div>
            
            <!-- Grupo de cámara con selector -->
            <div class="control-with-dropdown">
                <button id="camera-btn" class="control-btn active" title="Cámara">
                    <i class="fas fa-video"></i>
                </button>
                <button id="camera-selector-btn" class="control-dropdown-btn" title="Seleccionar cámara">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="control-dropdown" id="camera-device-dropdown">
                    <div class="device-dropdown-header">Seleccionar cámara</div>
                    <div class="device-list" id="camera-device-list">
                        <div class="device-loading">Cargando cámaras...</div>
                    </div>
                </div>
            </div>
            <button id="screen-share-btn" class="control-btn" title="Compartir pantalla">
                <i class="fas fa-desktop"></i>
            </button>
            <button id="reactions-btn" class="control-btn reactions-btn" title="Reacciones">
                <i class="fas fa-smile"></i>
            </button>
            <button id="cc-btn" class="control-btn" title="Subtítulos">
                <span style="font-weight: bold; font-size: 0.9em;">CC</span>
            </button>
            <button id="raise-hand-btn" class="control-btn raise-hand-btn" title="Levantar la mano">
                <i class="fas fa-hand-paper"></i>
            </button>
            <button id="whiteboard-btn" class="control-btn whiteboard-btn" title="Pizarra colaborativa">
                <i class="fas fa-paint-brush"></i>
            </button>
            <button id="more-options-right-btn" class="control-btn" title="Más opciones">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <button id="leave-btn" class="control-btn leave-btn" title="Salir">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
        
        <!-- Indicador de mano levantada -->
        <div id="raised-hand-indicator" class="raised-hand-indicator">
            <i class="fas fa-hand-paper hand-icon"></i>
            <span class="user-name" id="raised-hand-user-name"></span>
        </div>
        
        <!-- Panel de reacciones -->
        <div id="reactions-panel" class="reactions-panel">
            <div class="skin-tone-selector" id="skin-tone-selector">
                <div class="skin-tone-option skin-tone-1 selected" data-tone="1" title="Tono de piel 1"></div>
                <div class="skin-tone-option skin-tone-2" data-tone="2" title="Tono de piel 2"></div>
                <div class="skin-tone-option skin-tone-3" data-tone="3" title="Tono de piel 3"></div>
                <div class="skin-tone-option skin-tone-4" data-tone="4" title="Tono de piel 4"></div>
                <div class="skin-tone-option skin-tone-5" data-tone="5" title="Tono de piel 5"></div>
                <div class="skin-tone-option skin-tone-6" data-tone="6" title="Tono de piel 6"></div>
            </div>
            <div class="emoji-reactions-bar" id="emoji-reactions-bar">
                <!-- Los emojis se agregarán dinámicamente -->
            </div>
        </div>
        
        <!-- Pizarra colaborativa -->
        <div id="whiteboard-panel" class="whiteboard-panel">
            <div class="whiteboard-header">
                <h3><i class="fas fa-paint-brush"></i> Pizarra Colaborativa</h3>
                <div class="whiteboard-header-controls">
                    <div id="whiteboard-drawing-indicator" class="whiteboard-drawing-indicator">
                        <i class="fas fa-pencil-alt"></i>
                        <span class="drawing-user-name"></span> está dibujando...
                    </div>
                    <select id="whiteboard-mode-selector" class="whiteboard-mode-selector" onchange="handleWhiteboardModeChange()">
                        <option value="general">📋 Pizarra General</option>
                    </select>
                    <button id="whiteboard-close-btn" class="whiteboard-close-btn" title="Cerrar pizarra">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="whiteboard-toolbar">
                <div class="whiteboard-tools-group">
                    <button class="whiteboard-tool-btn active" data-tool="pen" title="Lápiz" onclick="setTool('pen')">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="eraser" title="Borrador (también borra post-its)" onclick="setTool('eraser')">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="line" title="Línea" onclick="setTool('line')">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="rectangle" title="Rectángulo" onclick="setTool('rectangle')">
                        <i class="fas fa-square"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="circle" title="Círculo" onclick="setTool('circle')">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="text" title="Texto" onclick="setTool('text')">
                        <i class="fas fa-font"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="move" title="Mover Texto/Post-its (Delete para borrar)" onclick="setTool('move')">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button class="whiteboard-tool-btn" data-tool="postit" title="Post-it" onclick="setTool('postit')">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                </div>
                <div class="whiteboard-postit-colors-group" id="whiteboard-postit-color-group" style="display: none; align-items: center; gap: 8px; padding: 4px 8px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; opacity: 0.5; pointer-events: none;">
                    <label style="font-size: 0.85em; font-weight: 500; color: #333; white-space: nowrap;">Color fondo:</label>
                    <button class="whiteboard-postit-color-btn active" data-postit-color="#FFEB3B" style="background: #FFEB3B; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Amarillo" onclick="setPostItColor('#FFEB3B')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#FFC107" style="background: #FFC107; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Ámbar" onclick="setPostItColor('#FFC107')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#FF9800" style="background: #FF9800; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Naranja" onclick="setPostItColor('#FF9800')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#4CAF50" style="background: #4CAF50; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Verde" onclick="setPostItColor('#4CAF50')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#2196F3" style="background: #2196F3; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Azul" onclick="setPostItColor('#2196F3')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#9C27B0" style="background: #9C27B0; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Púrpura" onclick="setPostItColor('#9C27B0')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#F44336" style="background: #F44336; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Rojo" onclick="setPostItColor('#F44336')"></button>
                    <button class="whiteboard-postit-color-btn" data-postit-color="#E91E63" style="background: #E91E63; width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;" title="Rosa" onclick="setPostItColor('#E91E63')"></button>
                    <input type="color" id="whiteboard-custom-postit-color" class="whiteboard-custom-color" value="#FFEB3B" title="Color personalizado" onchange="setPostItColor(this.value)" style="width: 40px; height: 30px; border: 2px solid #333; border-radius: 4px; cursor: pointer;">
                </div>
                <div class="whiteboard-colors-group">
                    <button class="whiteboard-color-btn active" data-color="#000000" style="background: #000000;" title="Negro" onclick="setColor('#000000')"></button>
                    <button class="whiteboard-color-btn" data-color="#FF0000" style="background: #FF0000;" title="Rojo" onclick="setColor('#FF0000')"></button>
                    <button class="whiteboard-color-btn" data-color="#0000FF" style="background: #0000FF;" title="Azul" onclick="setColor('#0000FF')"></button>
                    <button class="whiteboard-color-btn" data-color="#00FF00" style="background: #00FF00;" title="Verde" onclick="setColor('#00FF00')"></button>
                    <button class="whiteboard-color-btn" data-color="#FFFF00" style="background: #FFFF00;" title="Amarillo" onclick="setColor('#FFFF00')"></button>
                    <button class="whiteboard-color-btn" data-color="#FF00FF" style="background: #FF00FF;" title="Magenta" onclick="setColor('#FF00FF')"></button>
                    <button class="whiteboard-color-btn" data-color="#FFA500" style="background: #FFA500;" title="Naranja" onclick="setColor('#FFA500')"></button>
                    <button class="whiteboard-color-btn" data-color="#800080" style="background: #800080;" title="Púrpura" onclick="setColor('#800080')"></button>
                    <input type="color" id="whiteboard-custom-color" class="whiteboard-custom-color" value="#000000" title="Color personalizado" onchange="setColor(this.value)">
                </div>
                <div class="whiteboard-width-group">
                    <button class="whiteboard-width-btn" data-width="2" title="Fino" onclick="setLineWidth(2)">─</button>
                    <button class="whiteboard-width-btn active" data-width="3" title="Mediano" onclick="setLineWidth(3)">━</button>
                    <button class="whiteboard-width-btn" data-width="5" title="Grueso" onclick="setLineWidth(5)">━</button>
                    <button class="whiteboard-width-btn" data-width="8" title="Muy grueso" onclick="setLineWidth(8)">━</button>
                </div>
                <div class="whiteboard-text-group" id="whiteboard-text-group" style="display: none; align-items: center; gap: 8px; padding: 4px 8px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; opacity: 0.5; pointer-events: none;">
                    <label for="whiteboard-font-size" style="font-size: 0.85em; font-weight: 500; color: #333; white-space: nowrap;">Tamaño:</label>
                    <input type="range" id="whiteboard-font-size" min="8" max="72" value="16" step="1" style="display: none;" 
                           oninput="setFontSize(this.value)" style="width: 100px; margin: 0 5px; cursor: pointer;">
                    <span id="whiteboard-font-size-display" style="font-size: 0.85em; font-weight: 600; color: #333; min-width: 45px; display: inline-block; text-align: center;">16px</span>
                    <label for="whiteboard-font-family" style="font-size: 0.85em; font-weight: 500; color: #333; margin-left: 8px; white-space: nowrap;">Fuente:</label>
                    <select id="whiteboard-font-family" onchange="setFontFamily(this.value)" 
                            style="padding: 6px 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9em; background: white; cursor: pointer; min-width: 140px;">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Impact">Impact</option>
                        <option value="Trebuchet MS">Trebuchet MS</option>
                    </select>
                </div>
                <div class="whiteboard-actions-group">
                    <button class="whiteboard-action-btn" title="Limpiar pizarra" onclick="clearWhiteboard()">
                        <i class="fas fa-trash-alt"></i> Limpiar
                    </button>
                    <button class="whiteboard-action-btn" title="Guardar dibujo" onclick="saveDrawing()">
                        <i class="fas fa-download"></i> Guardar
                    </button>
                </div>
            </div>
            <div class="whiteboard-canvas-container">
                <canvas id="whiteboard-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Configuración de la sala (oculta, para evitar problemas con etiquetas Django en JS) -->
    <div id="room-config" 
         data-room-name="{{ room.name }}"
         data-user-name="{{ persona.nombre }} {{ persona.apellido }}"
         data-room-type="{{ room.room_type|default:'private' }}"
         data-is-couple-therapy="{% if room.is_couple_therapy %}true{% else %}false{% endif %}"
         data-user-role="{{ user_role|default:'paciente' }}"
         style="display: none;"></div>
    
    <!-- Scripts -->
    <script src="{% static 'videocall/js/streams_integrated.js' %}"></script>
    <script src="{% static 'videocall/js/videocall_chat.js' %}"></script>
    <script src="{% static 'videocall/js/device_controls.js' %}"></script>
    <script src="{% static 'videocall/js/whiteboard.js' %}"></script>
    
    <!-- Script para panel de usuarios -->
    <script>
        // Variables globales
        let canKickUsers = false;
        let participantsInterval = null;
        
        // Función para obtener el token CSRF
        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         (document.cookie.match(/csrftoken=([^;]+)/) || [])[1];
            return token || '';
        }
        
        // Función para escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Función para obtener iniciales del nombre
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name[0].toUpperCase();
        }
        
        // Función para cargar participantes
        function loadParticipants() {
            const roomName = window.VIDEOCALL_ROOM || sessionStorage.getItem('room') || '';
            if (!roomName) {
                console.warn('No hay nombre de sala disponible');
                return;
            }
            
            fetch(`/videocall/get_participants/${roomName}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar participantes');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    canKickUsers = data.can_kick || false;
                    const usersList = document.getElementById('users-list');
                    const usersCount = document.getElementById('users-count');
                    
                    if (!usersList || !usersCount) {
                        console.warn('Elementos del panel de usuarios no encontrados');
                        return;
                    }
                    
                    // Actualizar contador
                    usersCount.textContent = `${data.total} ${data.total === 1 ? 'participante' : 'participantes'}`;
                    
                    // Limpiar lista
                    usersList.innerHTML = '';
                    
                    if (data.participants.length === 0) {
                        usersList.innerHTML = '<div style="color: #a0aec0; text-align: center; padding: var(--spacing-md); font-size: 0.9em;">No hay participantes</div>';
                        return;
                    }
                    
                    // Agregar cada participante
                    data.participants.forEach(participant => {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item' + (participant.is_current_user ? ' current-user' : '');
                        userItem.setAttribute('data-participant-id', participant.id);
                        // IMPORTANTE: Agregar data-uid para que el selector de pizarras pueda identificarlo
                        if (participant.uid) {
                            userItem.setAttribute('data-uid', String(participant.uid));
                        }
                        
                        const initials = getInitials(participant.name);
                        const roleLabel = participant.role === 'psicologo' ? 'Psicólogo' :
                                         participant.role === 'practicante' ? 'Practicante' :
                                         participant.role === 'paciente' ? 'Paciente' :
                                         participant.role === 'audience' ? 'Audiencia' : participant.role;
                        
                        // Verificar si tiene la mano levantada
                        const isHandRaised = typeof window.raisedHands !== 'undefined' && window.raisedHands && window.raisedHands.has(participant.name);
                        const handRaisedClass = isHandRaised ? ' hand-raised' : '';
                        const handRaisedBadge = isHandRaised ? '<span class="hand-raised-badge"><i class="fas fa-hand-paper"></i> Mano levantada</span>' : '';
                        
                        userItem.innerHTML = `
                            <div class="user-info">
                                <div class="user-avatar">${escapeHtml(initials)}</div>
                                <div class="user-details">
                                    <div class="user-name">${escapeHtml(participant.name)}${handRaisedBadge}</div>
                                    <div class="user-role">${escapeHtml(roleLabel)}</div>
                                </div>
                            </div>
                            <div class="user-actions">
                                ${canKickUsers && !participant.is_current_user ? 
                                    `<button class="kick-btn" data-participant-id="${participant.id}" data-participant-name="${escapeHtml(participant.name)}" title="Expulsar usuario">
                                        <i class="fas fa-user-times"></i>
                                    </button>` : ''}
                            </div>
                        `;
                        
                        // Agregar clase si tiene la mano levantada
                        if (isHandRaised) {
                            userItem.classList.add('hand-raised');
                        }
                        
                        usersList.appendChild(userItem);
                        
                        // Agregar event listener al botón de expulsar si existe
                        if (canKickUsers && !participant.is_current_user) {
                            const kickBtn = userItem.querySelector('.kick-btn');
                            if (kickBtn) {
                                kickBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    const participantId = parseInt(this.getAttribute('data-participant-id'));
                                    const participantName = this.getAttribute('data-participant-name');
                                    if (window.kickUser) {
                                        window.kickUser(participantId, participantName);
                                    } else {
                                        console.error('Función kickUser no está disponible');
                                    }
                                });
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error cargando participantes:', error);
                });
        }
        
        // Función para expulsar usuario (disponible globalmente)
        window.kickUser = function(participantId, userName) {
            console.log('[kickUser] Intentando expulsar usuario:', participantId, userName);
            
            if (!participantId || !userName) {
                console.error('[kickUser] Datos inválidos:', { participantId, userName });
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Datos inválidos para expulsar usuario'
                });
                return;
            }
            
            if (!confirm(`¿Estás seguro de que deseas expulsar a ${userName} de la reunión?`)) {
                return;
            }
            
            const roomName = window.VIDEOCALL_ROOM || sessionStorage.getItem('room') || '';
            if (!roomName) {
                console.error('[kickUser] No hay nombre de sala disponible');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo identificar la sala'
                });
                return;
            }
            
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                console.error('[kickUser] Token CSRF no encontrado');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo obtener el token de seguridad'
                });
                return;
            }
            
            console.log('[kickUser] Enviando petición:', { room_name: roomName, participant_id: participantId });
            
            fetch('/videocall/kick_participant/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    room_name: roomName,
                    participant_id: participantId
                })
            })
            .then(response => {
                console.log('[kickUser] Respuesta recibida:', response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `Error ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('[kickUser] Datos recibidos:', data);
                if (data.success) {
                    // Remover el video del usuario expulsado
                    if (data.uid) {
                        console.log('[kickUser] Removiendo video del usuario expulsado, UID:', data.uid);
                        const userContainer = document.getElementById(`user-container-${data.uid}`);
                        if (userContainer) {
                            console.log('[kickUser] Contenedor encontrado, removiendo...');
                            userContainer.remove();
                            
                            // También remover de remoteUsers si existe (a través de AgoraVideoCall o directamente)
                            try {
                                if (window.AgoraVideoCall && typeof window.AgoraVideoCall.remoteUsers === 'function') {
                                    const remoteUsers = window.AgoraVideoCall.remoteUsers();
                                    if (remoteUsers && remoteUsers[data.uid]) {
                                        delete remoteUsers[data.uid];
                                        console.log('[kickUser] Usuario removido de remoteUsers');
                                    }
                                }
                            } catch (e) {
                                console.warn('[kickUser] No se pudo acceder a remoteUsers:', e);
                            }
                            
                            // Actualizar contador de participantes
                            if (typeof updateMemberCount === 'function') {
                                updateMemberCount();
                            }
                        } else {
                            console.warn('[kickUser] No se encontró el contenedor de video para UID:', data.uid);
                        }
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Usuario expulsado',
                        text: data.message || 'El usuario ha sido expulsado de la reunión',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recargar lista de participantes
                    setTimeout(() => {
                        if (typeof loadParticipants === 'function') {
                            loadParticipants();
                        }
                    }, 500);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'No se pudo expulsar al usuario'
                    });
                }
            })
            .catch(error => {
                console.error('[kickUser] Error expulsando usuario:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Error al expulsar al usuario'
                });
            });
        };
        
        // Inicializar panel de usuarios cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar participantes inicialmente
            loadParticipants();
            
            // Actualizar lista cada 3 segundos
            participantsInterval = setInterval(loadParticipants, 3000);
        });
        
        // Limpiar intervalo al salir
        window.addEventListener('beforeunload', function() {
            if (participantsInterval) {
                clearInterval(participantsInterval);
            }
        });
    </script>
    
    <script>
        // Leer configuración desde atributo data
        const roomConfigElement = document.getElementById('room-config');
        const roomName = roomConfigElement ? roomConfigElement.getAttribute('data-room-name') : '';
        const userName = roomConfigElement ? roomConfigElement.getAttribute('data-user-name') : '';
        const roomType = roomConfigElement ? roomConfigElement.getAttribute('data-room-type') : 'private';
        const isCoupleTherapy = roomConfigElement ? roomConfigElement.getAttribute('data-is-couple-therapy') === 'true' : false;
        const userRole = roomConfigElement ? roomConfigElement.getAttribute('data-user-role') : 'paciente';
        
        // Inicializar datos de sesión si no existen
        if (!sessionStorage.getItem('room') || sessionStorage.getItem('room') !== roomName) {
            sessionStorage.setItem('room', roomName);
            console.log('Sala guardada en sessionStorage:', roomName);
        }
        if (!sessionStorage.getItem('name') || sessionStorage.getItem('name') !== userName) {
            sessionStorage.setItem('name', userName);
            console.log('Nombre guardado en sessionStorage:', userName);
        }
        
        // También guardar en variables globales para acceso inmediato
        window.VIDEOCALL_ROOM = roomName;
        window.VIDEOCALL_USER = userName;
        
        if (!sessionStorage.getItem('roomType')) {
            sessionStorage.setItem('roomType', roomType);
        }
        if (!sessionStorage.getItem('isCoupleTherapy')) {
            sessionStorage.setItem('isCoupleTherapy', isCoupleTherapy);
        }
        if (!sessionStorage.getItem('userRole')) {
            sessionStorage.setItem('userRole', userRole);
        }
        
        // Mostrar información del tipo de sala (usar variables ya definidas arriba)
        
        // Actualizar badge de tipo de sala
        const roomTypeBadge = document.getElementById('room-type-badge');
        if (roomTypeBadge) {
            if (roomType === 'group') {
                roomTypeBadge.innerHTML = '🌐 Evento Grupal';
                roomTypeBadge.style.background = 'rgba(16, 185, 129, 0.2)';
                roomTypeBadge.style.color = '#10b981';
            } else if (isCoupleTherapy) {
                roomTypeBadge.innerHTML = '💑 Terapia de Pareja';
                roomTypeBadge.style.background = 'rgba(236, 72, 153, 0.2)';
                roomTypeBadge.style.color = '#ec4899';
            } else {
                roomTypeBadge.innerHTML = '🔒 Sesión Privada';
                roomTypeBadge.style.background = 'rgba(102, 126, 234, 0.2)';
                roomTypeBadge.style.color = '#667eea';
            }
        }
        
        // Timer de la sala
        let startTime = Date.now();
        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const timerElement = document.getElementById('room-timer');
            if (timerElement) {
                timerElement.textContent = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
            }
        }
        setInterval(updateTimer, 1000);
        
        // Inicializar Agora cuando la página esté lista
        function initializeVideoCall() {
            // Esperar a que Agora SDK esté cargado
            if (typeof AgoraRTC === 'undefined') {
                console.warn('Agora SDK aún no está cargado, esperando...');
                setTimeout(initializeVideoCall, 200);
                return;
            }
            
            if (typeof joinAndDisplayLocalStream === 'undefined') {
                console.warn('Funciones de Agora aún no están disponibles, esperando...');
                setTimeout(initializeVideoCall, 200);
                return;
            }
            
            // Asegurar que los datos estén en sessionStorage
            if (window.VIDEOCALL_ROOM) {
                sessionStorage.setItem('room', window.VIDEOCALL_ROOM);
            }
            if (window.VIDEOCALL_USER) {
                sessionStorage.setItem('name', window.VIDEOCALL_USER);
            }
            
            // Pequeño delay para asegurar que todo esté listo
            setTimeout(() => {
                console.log('Inicializando videollamada...');
                console.log('Datos disponibles:', {
                    room: window.VIDEOCALL_ROOM || sessionStorage.getItem('room'),
                    name: window.VIDEOCALL_USER || sessionStorage.getItem('name')
                });
                
                // Solo inicializar una vez
                if (typeof window.VIDEOCALL_INITIALIZED === 'undefined') {
                    window.VIDEOCALL_INITIALIZED = true;
                    
                    joinAndDisplayLocalStream().then(() => {
                        // Actualizar contador después de unirse
                        setTimeout(() => {
                            if (typeof updateMemberCount === 'function') {
                                updateMemberCount();
                            }
                        }, 1000);
                    }).catch(error => {
                        console.error('Error inicializando videollamada:', error);
                        console.error('Stack trace:', error.stack);
                        
                        let errorMessage = 'No se pudo conectar a la videollamada.';
                        if (error.message) {
                            errorMessage += '\n\n' + error.message;
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de conexión',
                            html: errorMessage.replace(/\n/g, '<br>'),
                            confirmButtonText: 'Recargar',
                            allowOutsideClick: false,
                            footer: '<small>Si el problema persiste, verifica que las credenciales de Agora estén configuradas en el archivo .env</small>'
                        }).then(() => {
                            window.location.reload();
                        });
                    });
                } else {
                    console.log('Videollamada ya inicializada, omitiendo...');
                }
            }, 1000);
        }
        
        // Ejecutar cuando la página esté lista
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeVideoCall);
        } else {
            // DOM ya está listo
            initializeVideoCall();
        }
        
        // ============================================
        // SISTEMA DE REACCIONES
        // ============================================
        
        let selectedSkinTone = 1; // Tono de piel por defecto (amarillo)
        const reactionsPanel = document.getElementById('reactions-panel');
        const reactionsBtn = document.getElementById('reactions-btn');
        const emojiReactionsBar = document.getElementById('emoji-reactions-bar');
        const skinToneSelector = document.getElementById('skin-tone-selector');
        
        // Emojis disponibles con sus variantes de tono de piel
        const emojiReactions = [
            { base: '👍', name: 'thumbs_up', variants: ['👍', '👍🏻', '👍🏼', '👍🏽', '👍🏾', '👍🏿'] },
            { base: '👏', name: 'clap', variants: ['👏', '👏🏻', '👏🏼', '👏🏽', '👏🏾', '👏🏿'] },
            { base: '❤️', name: 'heart', variants: ['❤️'] },
            { base: '🎉', name: 'party', variants: ['🎉'] },
            { base: '😂', name: 'laugh', variants: ['😂'] },
            { base: '😮', name: 'surprised', variants: ['😮'] },
            { base: '😢', name: 'sad', variants: ['😢'] },
            { base: '🤔', name: 'thinking', variants: ['🤔'] },
            { base: '👎', name: 'thumbs_down', variants: ['👎', '👎🏻', '👎🏼', '👎🏽', '👎🏾', '👎🏿'] },
            { base: '🔥', name: 'fire', variants: ['🔥'] },
            { base: '⭐', name: 'star', variants: ['⭐'] },
            { base: '💯', name: '100', variants: ['💯'] }
        ];
        
        // Inicializar panel de reacciones
        function initializeReactionsPanel() {
            if (!emojiReactionsBar) return;
            
            // Limpiar barra
            emojiReactionsBar.innerHTML = '';
            
            // Agregar cada emoji
            emojiReactions.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-reaction-btn';
                btn.setAttribute('data-emoji', emoji.name);
                btn.setAttribute('data-base', emoji.base);
                btn.textContent = emoji.variants[selectedSkinTone - 1] || emoji.base;
                btn.title = emoji.name;
                btn.addEventListener('click', () => sendReaction(emoji.name, emoji.variants[selectedSkinTone - 1] || emoji.base));
                emojiReactionsBar.appendChild(btn);
            });
        }
        
        // Manejar selección de tono de piel
        if (skinToneSelector) {
            skinToneSelector.addEventListener('click', (e) => {
                const toneOption = e.target.closest('.skin-tone-option');
                if (!toneOption) return;
                
                // Remover selección anterior
                skinToneSelector.querySelectorAll('.skin-tone-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Agregar selección nueva
                toneOption.classList.add('selected');
                selectedSkinTone = parseInt(toneOption.getAttribute('data-tone'));
                
                // Actualizar emojis con el nuevo tono
                initializeReactionsPanel();
            });
        }
        
        // Toggle panel de reacciones
        if (reactionsBtn && reactionsPanel) {
            reactionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                reactionsPanel.classList.toggle('show');
                reactionsBtn.classList.toggle('active');
            });
            
            // Cerrar panel al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (reactionsPanel && reactionsPanel.classList.contains('show')) {
                    if (!reactionsPanel.contains(e.target) && !reactionsBtn.contains(e.target)) {
                        reactionsPanel.classList.remove('show');
                        reactionsBtn.classList.remove('active');
                    }
                }
            });
        }
        
        // Enviar reacción
        function sendReaction(emojiName, emoji) {
            console.log('[Reacciones] Enviando reacción:', emojiName, emoji);
            
            // Cerrar panel
            if (reactionsPanel) {
                reactionsPanel.classList.remove('show');
            }
            if (reactionsBtn) {
                reactionsBtn.classList.remove('active');
            }
            
            // Mostrar animación local
            showReactionAnimation(emoji, true);
            
            // Enviar reacción a través del chat
            const roomName = window.VIDEOCALL_ROOM || sessionStorage.getItem('room') || '';
            const userName = window.VIDEOCALL_USER || sessionStorage.getItem('name') || 'Usuario';
            
            if (!roomName) {
                console.error('[Reacciones] No hay nombre de sala disponible');
                return;
            }
            
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                console.error('[Reacciones] Token CSRF no encontrado');
                return;
            }
            
            // Enviar como mensaje especial de reacción
            fetch('/videocall/send_message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    room_name: roomName,
                    message: `REACTION:${emoji}:${emojiName}`,
                    is_reaction: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('[Reacciones] Reacción enviada exitosamente');
                } else {
                    console.error('[Reacciones] Error enviando reacción:', data.error);
                }
            })
            .catch(error => {
                console.error('[Reacciones] Error enviando reacción:', error);
            });
        }
        
        // Mostrar animación de reacción
        function showReactionAnimation(emoji, isLocal = false) {
            const reactionEl = document.createElement('div');
            reactionEl.className = 'reaction-animation';
            reactionEl.textContent = emoji;
            
            // Posición aleatoria en la pantalla
            const x = isLocal ? 
                window.innerWidth / 2 + (Math.random() * 200 - 100) : 
                Math.random() * (window.innerWidth - 100) + 50;
            const y = isLocal ? 
                window.innerHeight / 2 + (Math.random() * 200 - 100) : 
                Math.random() * (window.innerHeight - 300) + 100;
            
            reactionEl.style.left = x + 'px';
            reactionEl.style.top = y + 'px';
            
            document.body.appendChild(reactionEl);
            
            // Remover después de la animación
            setTimeout(() => {
                if (reactionEl.parentNode) {
                    reactionEl.parentNode.removeChild(reactionEl);
                }
            }, 3000);
        }
        
        // Escuchar reacciones del chat (función global)
        window.handleReactionMessage = function(message) {
            if (!message || !message.message) return;
            
            if (message.message.startsWith('REACTION:')) {
                const parts = message.message.split(':');
                if (parts.length >= 3) {
                    const emoji = parts[1];
                    const emojiName = parts[2];
                    console.log('[Reacciones] Reacción recibida:', emoji, emojiName, 'de', message.author || 'desconocido');
                    
                    // Mostrar animación
                    if (typeof showReactionAnimation === 'function') {
                        showReactionAnimation(emoji, false);
                    }
                }
            } else if (message.message.startsWith('RAISE_HAND:')) {
                // Manejar mensajes de mano levantada
                console.log('[Reacciones] Mensaje de mano levantada detectado:', message.message);
                if (typeof window.handleRaiseHandMessage === 'function') {
                    window.handleRaiseHandMessage(message);
                } else {
                    console.warn('[Reacciones] handleRaiseHandMessage no está disponible');
                }
            }
        };
        
        // Inicializar panel cuando la página esté lista
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeReactionsPanel);
        } else {
            initializeReactionsPanel();
        }
        
        // ============================================
        // SISTEMA DE LEVANTAR LA MANO
        // ============================================
        
        let isHandRaised = false;
        const raiseHandBtn = document.getElementById('raise-hand-btn');
        const raisedHandIndicator = document.getElementById('raised-hand-indicator');
        const raisedHandUserName = document.getElementById('raised-hand-user-name');
        // Variable global para almacenar quién tiene la mano levantada
        window.raisedHands = window.raisedHands || new Map();
        const raisedHands = window.raisedHands;
        
        // Toggle levantar la mano
        if (raiseHandBtn) {
            raiseHandBtn.addEventListener('click', () => {
                isHandRaised = !isHandRaised;
                updateRaiseHandState();
                sendRaiseHandState(isHandRaised);
            });
        }
        
        // Actualizar estado visual del botón
        function updateRaiseHandState() {
            if (raiseHandBtn) {
                if (isHandRaised) {
                    raiseHandBtn.classList.add('active');
                    raiseHandBtn.title = 'Bajar la mano';
                } else {
                    raiseHandBtn.classList.remove('active');
                    raiseHandBtn.title = 'Levantar la mano';
                }
            }
            
            // Actualizar indicador local
            const currentUserName = window.VIDEOCALL_USER || sessionStorage.getItem('name') || 'Tú';
            updateRaisedHandIndicator(currentUserName, isHandRaised);
        }
        
        // Enviar estado de mano levantada
        function sendRaiseHandState(raised) {
            const roomName = window.VIDEOCALL_ROOM || sessionStorage.getItem('room') || '';
            const userName = window.VIDEOCALL_USER || sessionStorage.getItem('name') || 'Usuario';
            
            if (!roomName) {
                console.error('[Raise Hand] No hay nombre de sala disponible');
                return;
            }
            
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                console.error('[Raise Hand] Token CSRF no encontrado');
                return;
            }
            
            // Enviar como mensaje especial
            fetch('/videocall/send_message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    room_name: roomName,
                    message: `RAISE_HAND:${raised ? 'UP' : 'DOWN'}:${userName}`,
                    is_reaction: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('[Raise Hand] Estado enviado exitosamente:', raised ? 'UP' : 'DOWN');
                } else {
                    console.error('[Raise Hand] Error enviando estado:', data.error);
                }
            })
            .catch(error => {
                console.error('[Raise Hand] Error enviando estado:', error);
            });
        }
        
        // Actualizar indicador visual
        function updateRaisedHandIndicator(userName, raised) {
            if (!raisedHandIndicator || !raisedHandUserName) return;
            
            if (raised) {
                raisedHandUserName.textContent = userName;
                raisedHandIndicator.classList.add('show');
            } else {
                raisedHandIndicator.classList.remove('show');
            }
        }
        
        // Inicializar pizarra colaborativa
        const whiteboardBtn = document.getElementById('whiteboard-btn');
        const whiteboardCloseBtn = document.getElementById('whiteboard-close-btn');
        
        if (whiteboardBtn) {
            whiteboardBtn.addEventListener('click', () => {
                if (typeof toggleWhiteboard === 'function') {
                    toggleWhiteboard();
                    whiteboardBtn.classList.toggle('active');
                } else {
                    console.error('toggleWhiteboard no está disponible');
                }
            });
        }
        
        if (whiteboardCloseBtn) {
            whiteboardCloseBtn.addEventListener('click', () => {
                if (typeof toggleWhiteboard === 'function') {
                    toggleWhiteboard();
                    if (whiteboardBtn) {
                        whiteboardBtn.classList.remove('active');
                    }
                }
            });
        }
        
        // Actualizar selector de pizarras cuando se cargan los participantes
        const originalLoadParticipants = window.loadParticipants;
        if (typeof originalLoadParticipants === 'function') {
            window.loadParticipants = function() {
                originalLoadParticipants();
                // Actualizar selector de pizarras después de cargar participantes
                if (typeof updateWhiteboardSelector === 'function') {
                    setTimeout(() => {
                        updateWhiteboardSelector();
                    }, 100);
                }
            };
        }
        
        // Manejar mensajes de mano levantada
        window.handleRaiseHandMessage = function(message) {
            if (!message || !message.message || !message.message.startsWith('RAISE_HAND:')) {
                return;
            }
            
            const parts = message.message.split(':');
            if (parts.length < 3) {
                console.warn('[Raise Hand] Formato de mensaje inválido:', message.message);
                return;
            }
            
            const state = parts[1]; // 'UP' o 'DOWN'
            const userName = parts[2];
            const isRaised = state === 'UP';
            
            console.log('[Raise Hand] Estado recibido:', state, 'de', userName, '(autor del mensaje:', message.author || 'desconocido', ')');
            
            // Usar el nombre del autor del mensaje si está disponible, de lo contrario usar el del mensaje
            const actualUserName = message.author || userName;
            
            // Actualizar mapa de manos levantadas
            if (isRaised) {
                raisedHands.set(actualUserName, true);
                console.log('[Raise Hand] Mano levantada agregada para:', actualUserName, 'Total:', raisedHands.size);
            } else {
                raisedHands.delete(actualUserName);
                console.log('[Raise Hand] Mano bajada removida para:', actualUserName, 'Total:', raisedHands.size);
            }
            
            // Actualizar indicador si es el usuario actual
            const currentUserName = window.VIDEOCALL_USER || sessionStorage.getItem('name') || '';
            const currentUserNameNormalized = currentUserName.trim().toLowerCase();
            const actualUserNameNormalized = actualUserName.trim().toLowerCase();
            
            console.log('[Raise Hand] Comparando nombres - Actual:', currentUserNameNormalized, 'vs Recibido:', actualUserNameNormalized);
            
            if (actualUserNameNormalized === currentUserNameNormalized || actualUserName === 'Tú' || actualUserName === currentUserName) {
                console.log('[Raise Hand] Es el usuario actual, actualizando estado local');
                isHandRaised = isRaised;
                updateRaiseHandState();
            } else {
                console.log('[Raise Hand] Es otro usuario, mostrando indicador');
                // Mostrar indicador para otros usuarios
                if (isRaised) {
                    updateRaisedHandIndicator(actualUserName, true);
                    // Ocultar después de 5 segundos si no es el usuario actual
                    setTimeout(() => {
                        if (raisedHandIndicator && !isHandRaised) {
                            raisedHandIndicator.classList.remove('show');
                        }
                    }, 5000);
                } else {
                    // Si no hay más manos levantadas, ocultar indicador
                    if (raisedHands.size === 0 || (raisedHands.size === 1 && raisedHands.has(currentUserName))) {
                        updateRaisedHandIndicator('', false);
                    }
                }
            }
            
            // Actualizar lista de participantes
            if (typeof loadParticipants === 'function') {
                console.log('[Raise Hand] Actualizando lista de participantes...');
                loadParticipants();
            }
        };
        
        // ============================================
        // TOGGLE ENTRE PARTICIPANTES Y CHAT
        // ============================================
        
        // Toggle entre participantes y chat
        const sidePanel = document.getElementById('side-panel');
        const usersPanel = document.getElementById('users-panel');
        const chatPanel = document.getElementById('chat-panel');
        const usersToggleControl = document.getElementById('users-toggle-control');
        const chatToggleControl = document.getElementById('chat-toggle-control');
        const roomMainContent = document.querySelector('.room-main-content');
        
        let currentView = 'users'; // 'users' o 'chat'
        
        function showUsersPanel() {
            if (!sidePanel || !usersPanel || !chatPanel) return;
            
            sidePanel.classList.remove('hidden');
            usersPanel.classList.remove('hidden');
            chatPanel.classList.add('hidden');
            currentView = 'users';
            
            // Actualizar botones
            if (usersToggleControl) {
                usersToggleControl.classList.add('active');
            }
            if (chatToggleControl) {
                chatToggleControl.classList.remove('active');
            }
            // Botón de cerrar removido - los botones de toggle ya cumplen esa función
            
            // Remover clase del contenedor principal
            if (roomMainContent) {
                roomMainContent.classList.remove('chat-hidden');
            }
        }
        
        function showChatPanel() {
            if (!sidePanel || !usersPanel || !chatPanel) return;
            
            sidePanel.classList.remove('hidden');
            usersPanel.classList.add('hidden');
            chatPanel.classList.remove('hidden');
            currentView = 'chat';
            
            // Actualizar botones
            if (usersToggleControl) {
                usersToggleControl.classList.remove('active');
            }
            if (chatToggleControl) {
                chatToggleControl.classList.add('active');
            }
            // Botón de cerrar removido - los botones de toggle ya cumplen esa función
            
            // Remover clase del contenedor principal
            if (roomMainContent) {
                roomMainContent.classList.remove('chat-hidden');
            }
            
            // Asegurar que el chat se inicialice
            setTimeout(() => {
                if (typeof initializeChat === 'function') {
                    initializeChat();
                } else if (typeof window.videocallChat !== 'undefined' && window.videocallChat.initializeChat) {
                    window.videocallChat.initializeChat();
                } else if (typeof loadChatMessages === 'function') {
                    loadChatMessages();
                }
            }, 100);
            
            // Inicializar polling de mensajes si no está activo (para detectar manos levantadas)
            if (!window.chatPollingActive) {
                startChatPolling();
            }
        }
        
        function hidePanel() {
            if (!sidePanel) return;
            
            sidePanel.classList.add('hidden');
            currentView = null;
            
            // Actualizar botones
            if (usersToggleControl) {
                usersToggleControl.classList.remove('active');
            }
            if (chatToggleControl) {
                chatToggleControl.classList.remove('active');
            }
            // Botón de cerrar removido - los botones de toggle ya cumplen esa función
            
            // Agregar clase al contenedor principal para expandir video
            if (roomMainContent) {
                roomMainContent.classList.add('chat-hidden');
            }
        }
        
        function toggleUsersPanel() {
            if (currentView === 'users') {
                hidePanel();
            } else {
                showUsersPanel();
            }
        }
        
        function toggleChatPanel() {
            if (currentView === 'chat') {
                hidePanel();
            } else {
                showChatPanel();
            }
        }
        
        // Conectar botones
        if (usersToggleControl) {
            usersToggleControl.addEventListener('click', toggleUsersPanel);
        }
        if (chatToggleControl) {
            chatToggleControl.addEventListener('click', toggleChatPanel);
        }
        // Botón de cerrar removido - los botones de toggle ya cumplen esa función
        
        // ============================================
        // POLLING DE MENSAJES (para detectar manos levantadas y reacciones)
        // ============================================
        
        let chatPollingInterval = null;
        window.chatPollingActive = false;
        
        function startChatPolling() {
            if (window.chatPollingActive) {
                console.log('[Chat Polling] Ya está activo');
                return;
            }
            
            console.log('[Chat Polling] Iniciando polling de mensajes...');
            window.chatPollingActive = true;
            
            // Cargar mensajes iniciales
            if (typeof loadChatMessages === 'function') {
                loadChatMessages();
            }
            
            // Función de polling recursiva que se ajusta dinámicamente
            const doPolling = () => {
                if (!window.chatPollingActive) {
                    return; // Detener si el polling fue desactivado
                }
                
                if (typeof loadChatMessages === 'function') {
                    loadChatMessages();
                }
                
                // Obtener intervalo dinámico según el estado de la pizarra
                let pollingInterval;
                if (typeof window.isWhiteboardOpen !== 'undefined' && window.isWhiteboardOpen) {
                    pollingInterval = 250; // 250ms = 0.25 segundos para tiempo real cuando la pizarra está abierta
                } else {
                    pollingInterval = 1500; // 1.5 segundos para polling normal
                }
                
                // Programar siguiente polling y guardar referencia
                chatPollingInterval = setTimeout(doPolling, pollingInterval);
            };
            
            // Iniciar polling
            const initialInterval = (typeof window.isWhiteboardOpen !== 'undefined' && window.isWhiteboardOpen) ? 250 : 1500;
            chatPollingInterval = setTimeout(doPolling, initialInterval);
        }
        
        function stopChatPolling() {
            if (chatPollingInterval) {
                clearTimeout(chatPollingInterval);
                chatPollingInterval = null;
            }
            window.chatPollingActive = false;
            console.log('[Chat Polling] Detenido');
        }
        
        // Inicializar polling cuando la página esté lista
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                hidePanel();
                // Iniciar polling después de un breve delay para asegurar que todo esté cargado
                setTimeout(() => {
                    startChatPolling();
                }, 2000);
            });
        } else {
            hidePanel();
            setTimeout(() => {
                startChatPolling();
            }, 2000);
        }
        
        // Los botones están conectados en streams_integrated.js
        // Solo asegurarnos de que todo esté listo después de que se cargue el script
        window.addEventListener('load', function() {
            // Asegurar que los datos estén en sessionStorage
            if (window.VIDEOCALL_ROOM) {
                sessionStorage.setItem('room', window.VIDEOCALL_ROOM);
            }
            if (window.VIDEOCALL_USER) {
                sessionStorage.setItem('name', window.VIDEOCALL_USER);
            }
            
            // Reconectar botones después de que todo esté cargado
            if (typeof connectControlButtons === 'function') {
                setTimeout(connectControlButtons, 500);
            }
            
            // Cargar mensajes iniciales del chat con retry
            // Inicializar chat después de que todo esté listo
            if (typeof window.videocallChat !== 'undefined' && typeof window.videocallChat.loadMessages === 'function') {
                setTimeout(() => {
                    window.videocallChat.loadMessages();
                }, 1000);
            } else if (typeof loadChatMessages === 'function') {
                setTimeout(() => {
                    loadChatMessages();
                }, 1000);
            }
            
            // Actualizar contador inicial
            if (typeof updateMemberCount === 'function') {
                setTimeout(() => {
                    updateMemberCount();
                }, 1500);
            }
            
            // Actualizar contador periódicamente (cada 2 segundos) para mantener sincronización
            setInterval(() => {
                if (typeof updateMemberCount === 'function') {
                    updateMemberCount();
                }
            }, 2000);
            
            // Inicializar funcionalidad de expandir videos
            initializeVideoExpand();
        });
        
        // Funcionalidad de expandir/zoom de videos
        let expandedVideoTrack = null;
        let expandedVideoUid = null;
        
        // Definir función expandVideo INMEDIATAMENTE (fuera de listeners)
        async function expandVideo(container) {
            console.log('expandVideo llamado con contenedor:', container);
            
            if (!container) {
                console.error('Contenedor no proporcionado');
                return;
            }
            
            const userName = container.querySelector('.user-name');
            const overlay = document.getElementById('video-expanded-overlay');
            const expandedName = document.getElementById('video-expanded-name');
            
            console.log('Elementos encontrados:', {
                container: !!container,
                userName: !!userName,
                overlay: !!overlay,
                expandedName: !!expandedName
            });
            
            if (!overlay) {
                console.error('Overlay no encontrado');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el overlay para expandir el video',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }
            
            // Obtener el UID del contenedor
            const containerId = container.id;
            console.log('Container ID:', containerId);
            const uidMatch = containerId.match(/user-container-(.+)/);
            if (!uidMatch) {
                console.error('No se pudo obtener UID del contenedor');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo identificar el video',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }
            
            const uid = uidMatch[1];
            console.log('UID extraído:', uid);
            expandedVideoUid = uid;
            
            // Guardar referencia al contenedor original
            const originalContainer = container;
            
            // Mostrar overlay
            overlay.classList.add('active');
            console.log('Overlay activado');
            
            // Actualizar nombre
            if (expandedName && userName) {
                expandedName.textContent = userName.textContent || 'Usuario';
            }
            
            // Hacer zoom CSS del contenedor original
            // Esto evita problemas con Agora al reproducir el mismo track en múltiples lugares
            try {
                // Agregar clase de expansión al contenedor original
                originalContainer.classList.add('video-container-expanded');
                
                // Asegurar que el contenedor esté visible sobre el overlay
                originalContainer.style.zIndex = '10001';
                
                console.log('Video expandido usando zoom CSS');
            } catch (error) {
                console.error('Error al expandir video:', error);
                console.error('Stack trace:', error.stack);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al expandir video',
                    text: error.message || 'No se pudo expandir el video',
                    timer: 3000,
                    showConfirmButton: false
                });
                closeExpandedVideo();
            }
        }
        
        function closeExpandedVideo() {
            console.log('Cerrando video expandido...');
            const overlay = document.getElementById('video-expanded-overlay');
            
            if (overlay) {
                overlay.classList.remove('active');
            }
            
            // Remover la clase de expansión del contenedor original
            if (expandedVideoUid) {
                const originalContainer = document.getElementById(`user-container-${expandedVideoUid}`);
                if (originalContainer) {
                    // Remover clase de expansión
                    originalContainer.classList.remove('video-container-expanded');
                    
                    // Restaurar z-index
                    originalContainer.style.zIndex = '';
                    
                    // Asegurar que el video esté visible y funcionando
                    const originalVideoPlayer = originalContainer.querySelector(`#user-${expandedVideoUid}`);
                    if (originalVideoPlayer) {
                        const originalVideo = originalVideoPlayer.querySelector('video');
                        if (originalVideo) {
                            // Asegurar que el video esté reproduciéndose
                            if (originalVideo.paused) {
                                originalVideo.play().catch(e => {
                                    console.warn('No se pudo reproducir video original:', e);
                                });
                            }
                        }
                    }
                    
                    console.log('Contenedor original restaurado a su estado normal');
                }
            }
            
            // Limpiar referencias
            expandedVideoTrack = null;
            expandedVideoUid = null;
            
            console.log('Video expandido cerrado, video original restaurado');
        }
        
        // Exponer funciones globalmente INMEDIATAMENTE
        window.expandVideo = expandVideo;
        window.closeExpandedVideo = closeExpandedVideo;
        console.log('expandVideo y closeExpandedVideo expuestas globalmente INMEDIATAMENTE');
        
        function initializeVideoExpand() {
            const overlay = document.getElementById('video-expanded-overlay');
            
            if (overlay) {
                // Cerrar al hacer clic fuera del video
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeExpandedVideo();
                    }
                });
                
                // Cerrar con tecla ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && overlay.classList.contains('active')) {
                        closeExpandedVideo();
                    }
                });
            }
            
            // Observar cuando se agregan nuevos videos al grid
            const videoGrid = document.getElementById('video-grid');
            if (videoGrid) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.id && node.id.startsWith('user-container-')) {
                                addExpandButtonToVideo(node);
                            }
                        });
                    });
                });
                
                observer.observe(videoGrid, { childList: true, subtree: true });
                
                // Agregar botones a videos existentes
                const existingVideos = videoGrid.querySelectorAll('[id^="user-container-"]');
                existingVideos.forEach(addExpandButtonToVideo);
            }
        }
        
        function addExpandButtonToVideo(container) {
            // Verificar si ya tiene el botón de expandir
            if (!container.querySelector('.expand-video-btn')) {
                console.log('Agregando botón de expandir a:', container.id);
                
                // Crear botón de expandir/comprimir
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-video-btn';
                expandBtn.title = 'Expandir video (o doble clic)';
                expandBtn.innerHTML = '<i class="fas fa-expand"></i><i class="fas fa-compress"></i>';
                expandBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Botón de expandir/comprimir clickeado');
                    // Verificar si el contenedor está expandido
                    if (container.classList.contains('video-container-expanded')) {
                        closeExpandedVideo();
                    } else {
                        expandVideo(container);
                    }
                });
                
                container.appendChild(expandBtn);
                console.log('Botón de expandir agregado');
                
                // También permitir expandir al hacer doble clic en el contenedor
                container.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    console.log('Doble clic en contenedor de video');
                    expandVideo(container);
                });
                
                // Agregar cursor pointer para indicar que es clickeable
                container.style.cursor = 'pointer';
            }
            
            // Agregar botón de mute solo para usuarios remotos (no para el video local)
            const containerId = container.id;
            const uidMatch = containerId.match(/user-container-(.+)/);
            if (uidMatch) {
                const uid = uidMatch[1];
                const currentUID = sessionStorage.getItem('UID') || (window.AgoraVideoCall ? window.AgoraVideoCall.UID() : null);
                
                // Solo agregar botón de mute si NO es el video local
                if (uid !== currentUID && uid !== String(currentUID)) {
                    if (!container.querySelector('.mute-remote-btn')) {
                        console.log('Agregando botón de mute a:', container.id);
                        
                        const muteBtn = document.createElement('button');
                        muteBtn.className = 'mute-remote-btn';
                        muteBtn.title = 'Mutear/Desmutear audio';
                        muteBtn.setAttribute('data-uid', uid);
                        muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        muteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('Botón mute clickeado para usuario:', uid);
                            if (window.AgoraVideoCall && window.AgoraVideoCall.toggleRemoteMute) {
                                window.AgoraVideoCall.toggleRemoteMute(uid, muteBtn);
                            } else {
                                console.error('toggleRemoteMute no está disponible');
                            }
                        });
                        
                        container.appendChild(muteBtn);
                        console.log('Botón de mute agregado');
                    }
                }
            }
        }
    </script>
</body>
</html>

